version: 2
jobs:
  checkout_code:
    docker:
      - image: circleci/ruby:2.5.1-node
    working_directory: ~/api.goodcity
    steps:
      - checkout
      - save_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/api.goodcity

  bundle_dependencies:
    docker:
      - image: circleci/ruby:2.5.1-node
    working_directory: ~/api.goodcity
    steps:
      - run: mkdir -p ~/.ssh && ssh-keyscan github.com >> ~/.ssh/known_hosts
      - run: gem install bundler
      - restore_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
      #- restore_cache:
      #    key: v1-bundle-{{ checksum "Gemfile.lock" }}
      - run: echo {{ checksum "Gemfile.lock" }}
      - run: git diff Gemfile.lock
      - run: bundle check --path=vendor/bundle || bundle install --deployment --jobs=4 --retry=3
      - run: echo {{ checksum "Gemfile.lock" }}
      - run: git diff Gemfile.lock
      # - save_cache:
      #     key: v1-bundle-{{ checksum "Gemfile.lock" }}
      #     paths:
      #       - vendor/bundle

  test:
    docker:
      - image: circleci/ruby:2.5.1-node
      - image: circleci/postgres:9.6.9-alpine-ram
      - image: circleci/redis:4.0.9-alpine
    working_directory: ~/api.goodcity
    environment:
      RAILS_ENV: TEST
    steps:
      - restore_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: v1-bundle-{{ checksum "Gemfile.lock" }}
      - run: echo "Test!"

  audit:
    docker:
      - image: circleci/ruby:2.5.1-node
    working_directory: ~/api.goodcity
    steps:
      - restore_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: v1-bundle-{{ checksum "Gemfile.lock" }}
      - run: gem install bundler-audit
      - run: bundle-audit -v --update

  deploy:
    docker:
      - image: circleci/ruby:2.5.1-node
    working_directory: ~/api.goodcity
    steps:
      - restore_cache:
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: v1-bundle-{{ checksum "Gemfile.lock" }}
      - run: echo "Deploy!"

workflows:
  version: 2
  build-test-audit-and-deploy:
    jobs:
      - checkout_code
      - bundle_dependencies:
          requires:
            - checkout_code
      - test:
          requires:
            - bundle_dependencies
      - audit:
          requires:
            - checkout_code
      - deploy:
          requires:
            - test
            - audit

